<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Reader with Real-Time Sync</title>
    <style>
        #text-display { font-size: 18px; line-height: 1.6; }
        .highlight { background-color: yellow; }
        .controls { position: fixed; top: 0; width: 100%; background: #f9f9f9; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="initializePlay()">Initialize and Play</button>
        <button onclick="resume()">Resume</button>
        <button onclick="pause()">Pause</button>
        <button onclick="stop()">Stop</button>
        <input type="range" id="progress-bar" value="0" max="100" step="1" onchange="seekToPosition()">
        <button onclick="saveBookmark()">Bookmark</button>
        <input type="file" id="pdf-file">
        <button onclick="uploadAndLoadText()">Upload and Load Text</button>
    </div>

    <h1>PDF Reader with Text Highlighting</h1>
    <div id="text-display"></div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const socket = io();
        let textData = [];
        let currentPosition = 0;

        function initializePlay() {
            socket.emit('control', { command: 'initialize', text_data: textData.join(" "), start_position: currentPosition });
        }

        function resume() {
            socket.emit('control', { command: 'resume', text_data: textData.join(" "), start_position: currentPosition });
        }

        function pause() {
            socket.emit('control', { command: 'pause' });
        }

        function stop() {
            currentPosition = 0;
            socket.emit('control', { command: 'stop' });
        }

        async function uploadAndLoadText() {
            const fileInput = document.getElementById("pdf-file");
            if (fileInput.files.length === 0) {
                alert("Please select a PDF file to upload.");
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            const uploadResponse = await fetch("/upload", {
                method: "POST",
                body: formData
            });

            const uploadData = await uploadResponse.json();
            if (uploadData.error) {
                alert(uploadData.error);
                return;
            }

            const loadTextResponse = await fetch("/load_text", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ pdf_path: uploadData.file_path })
            });

            const loadTextData = await loadTextResponse.json();
            if (loadTextData.error) {
                alert(loadTextData.error);
            } else {
                textData = loadTextData.text_data.split(" ");
                currentPosition = loadTextData.start_position;
                displayText();
            }
        }

        function displayText() {
            const textDisplay = document.getElementById("text-display");
            textDisplay.innerHTML = textData
                .map((word, i) => i === currentPosition ? `<span class="highlight">${word}</span>` : word)
                .join(" ");
        }

        socket.on('highlight_word', (data) => {
            currentPosition = data.position;
            displayText();
        });

        socket.on('update_progress', (data) => {
            document.getElementById('progress-bar').value = data.progress;
        });

        function seekToPosition() {
            const newPosition = document.getElementById("progress-bar").value;
            currentPosition = Math.floor((newPosition / 100) * textData.length);
            displayText();
            resume();
        }
    </script>
</body>
</html>

